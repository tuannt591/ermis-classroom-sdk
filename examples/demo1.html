<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ermis Classroom SDK - Production Demo</title>
    <style>
      /* Same CSS as before - keeping it identical for consistency */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .status {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-weight: 500;
      }

      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .status.connecting {
        background: #fff3cd;
        color: #856404;
      }
      .status.connected {
        background: #d1edff;
        color: #0c5460;
      }

      .auth-section,
      .room-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .auth-section h2,
      .room-section h2 {
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        background: #0056b3;
      }

      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.danger {
        background: #dc3545;
      }

      .meeting-area {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 20px;
        margin-bottom: 20px;
      }

      .video-container {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .main-video {
        height: 400px;
        background: #000;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
      }

      .video-tile video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #111;
        display: block;
      }

      .sidebar-videos {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .sidebar-videos h3 {
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .participant-list {
        list-style: none;
      }

      .participant-item {
        padding: 10px;
        margin-bottom: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .participant-item.local {
        background: #d1edff;
      }

      .participant-item.pinned {
        background: #d4edda;
      }

      .participant-controls {
        display: flex;
        gap: 5px;
      }

      .control-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }

      .control-btn.muted {
        background: #dc3545;
      }

      .logs {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .logs h3 {
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .log-container {
        height: 200px;
        overflow-y: auto;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 2px 0;
      }

      .log-entry.error {
        color: #dc3545;
      }

      .log-entry.success {
        color: #28a745;
      }

      .log-entry.info {
        color: #007bff;
      }

      .hidden {
        display: none;
      }

      .room-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-top: 10px;
      }

      .room-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .room-item:hover {
        background: #f8f9fa;
      }

      .room-item:last-child {
        border-bottom: none;
      }

      .room-code {
        font-family: monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
      }

      .breakout-rooms {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .breakout-rooms h3 {
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .subroom-list {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .subroom-item {
        background: #e9ecef;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        border: 2px solid transparent;
      }

      .subroom-item:hover {
        background: #dee2e6;
      }

      .subroom-item.active {
        background: #d1edff;
        border-color: #007bff;
      }

      .version-info {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>Ermis Classroom SDK - Production Demo</h1>
        <div id="versionInfo" class="version-info">Loading SDK...</div>
        <div id="connectionStatus" class="status disconnected">
          Disconnected
        </div>
      </div>

      <!-- Authentication Section -->
      <div id="authSection" class="auth-section">
        <h2>Authentication</h2>
        <div class="form-group">
          <label for="serverUrl">Server URL:</label>
          <input
            type="text"
            id="serverUrl"
            value="daibo.ermis.network:9999"
            placeholder="daibo.ermis.network:9999"
          />
        </div>
        <div class="form-group">
          <label for="userId">User ID (Email):</label>
          <input
            type="email"
            id="userId"
            value="nvhoangwru@gmail.com"
            placeholder="user@example.com"
          />
        </div>
        <button id="loginBtn" class="btn">Login</button>
        <button id="logoutBtn" class="btn secondary hidden">Logout</button>
        <button id="testConnectivityBtn" class="btn secondary">
          Test Connectivity
        </button>
      </div>

      <!-- Room Management Section -->
      <div id="roomSection" class="room-section hidden">
        <h2>Room Management</h2>

        <!-- Create Room -->
        <div class="form-group">
          <label for="roomName">Create New Room:</label>
          <input type="text" id="roomName" placeholder="Room name" />
          <select id="roomType">
            <option value="main">Main Room</option>
            <option value="presentation">Presentation</option>
            <option value="discussion">Discussion</option>
          </select>
          <button id="createRoomBtn" class="btn">Create Room</button>
        </div>

        <!-- Join Room -->
        <div class="form-group">
          <label for="roomCode">Join Room by Code:</label>
          <input
            type="text"
            id="roomCode"
            placeholder="5faf-bgj5-mhsy"
            value="5faf-bgj5-mhsy"
          />
          <button id="joinRoomBtn" class="btn">Join Room</button>
        </div>

        <!-- Current Room Info -->
        <div id="currentRoomInfo" class="hidden">
          <h3>Current Room: <span id="currentRoomName"></span></h3>
          <p>Participants: <span id="participantCount">0</span></p>
          <button id="leaveRoomBtn" class="btn danger">Leave Room</button>
        </div>

        <!-- Available Rooms -->
        <h4>Available Rooms:</h4>
        <button id="refreshRoomsBtn" class="btn secondary">
          Refresh Rooms
        </button>
        <div id="roomList" class="room-list">
          <div>Click Refresh to load rooms...</div>
        </div>
      </div>

      <!-- Breakout Rooms Section -->
      <div id="breakoutSection" class="breakout-rooms hidden">
        <h3>Breakout Rooms</h3>
        <div class="form-group">
          <input
            type="text"
            id="subRoomName"
            placeholder="Breakout room name"
          />
          <input
            type="number"
            id="maxParticipants"
            placeholder="Max participants"
            value="5"
            min="2"
            max="20"
          />
          <input
            type="number"
            id="duration"
            placeholder="Duration (minutes)"
            value="30"
            min="5"
            max="180"
          />
          <button id="createSubRoomBtn" class="btn">
            Create Breakout Room
          </button>
          <button id="returnToMainBtn" class="btn secondary hidden">
            Return to Main Room
          </button>
        </div>
        <div id="subRoomList" class="subroom-list"></div>
      </div>

      <!-- Meeting Area -->
      <div id="meetingArea" class="meeting-area hidden">
        <div class="video-container">
          <div id="mainVideo" class="main-video">
            <span>No video stream</span>
          </div>
        </div>

        <div class="sidebar-videos">
          <h3>Participants</h3>
          <ul id="participantList" class="participant-list"></ul>
        </div>
      </div>

      <!-- Logs Section -->
      <div class="logs">
        <h3>SDK Logs & Events</h3>
        <button id="clearLogsBtn" class="btn secondary">Clear Logs</button>
        <button id="exportLogsBtn" class="btn secondary">Export Logs</button>
        <div id="logContainer" class="log-container"></div>
      </div>
    </div>

    <!-- Production SDK Import -->
    <!-- Option 1: ES6 Module (if SDK built as ES module) -->
    <script type="module">
      // Import built SDK
      // import ErmisClassroom from './dist/ermis-classroom.js';
      const moduleUrl = "../dist/index.js?v=" + Date.now();
      const { default: ErmisClassroom } = await import(moduleUrl);
      const log = (msg) => {
        document.getElementById("log").textContent += msg + "\n";
      };
      // Or from CDN: import ErmisClassroom from 'https://unpkg.com/ermis-classroom-sdk';

      // Initialize demo application with real SDK
      window.initializeDemo(ErmisClassroom);
    </script>

    <!-- Option 2: UMD Bundle (fallback) -->
    <!-- <script>
    // Fallback for browsers that don't support ES6 modules
    if (!window.ErmisClassroom) {
      const script = document.createElement('script');
      script.src = './dist/ermis-classroom.umd.js'; // UMD bundle
      script.onload = () => {
        if (window.ErmisClassroom) {
          window.initializeDemo(window.ErmisClassroom);
        } else {
          console.error('Failed to load ErmisClassroom SDK');
          document.getElementById('versionInfo').textContent = 'Failed to load SDK';
        }
      };
      script.onerror = () => {
        console.error('Failed to load SDK script');
        document.getElementById('versionInfo').textContent = 'SDK loading failed';
      };
      document.head.appendChild(script);
    }
  </script> -->

    <!-- Demo Application -->
    <script>
      window.initializeDemo = function (ErmisClassroom) {
        // Display SDK version info
        document.getElementById("versionInfo").textContent = `SDK Version: ${
          ErmisClassroom.version || "Unknown"
        } | Status: Ready`;

        class ProductionDemo {
          constructor(SDK) {
            this.ErmisClassroom = SDK;
            this.client = null;
            this.currentRoom = null;
            this.participants = new Map();
            this.subRooms = new Map();
            this.initializeUI();

            // Log SDK info
            this.log(
              `SDK Loaded - Version: ${SDK.version || "Unknown"}`,
              "success"
            );
            this.log(
              `Available Events: ${Object.keys(SDK.events || {}).length}`,
              "info"
            );
            this.log(
              `Connection Status: ${Object.values(
                SDK.ConnectionStatus || {}
              ).join(", ")}`,
              "info"
            );
          }

          initializeUI() {
            // Get DOM elements (same as before)
            this.elements = {
              connectionStatus: document.getElementById("connectionStatus"),
              authSection: document.getElementById("authSection"),
              roomSection: document.getElementById("roomSection"),
              breakoutSection: document.getElementById("breakoutSection"),
              meetingArea: document.getElementById("meetingArea"),

              serverUrl: document.getElementById("serverUrl"),
              userId: document.getElementById("userId"),
              loginBtn: document.getElementById("loginBtn"),
              logoutBtn: document.getElementById("logoutBtn"),
              testConnectivityBtn: document.getElementById(
                "testConnectivityBtn"
              ),

              roomName: document.getElementById("roomName"),
              roomType: document.getElementById("roomType"),
              roomCode: document.getElementById("roomCode"),
              createRoomBtn: document.getElementById("createRoomBtn"),
              joinRoomBtn: document.getElementById("joinRoomBtn"),
              leaveRoomBtn: document.getElementById("leaveRoomBtn"),
              refreshRoomsBtn: document.getElementById("refreshRoomsBtn"),
              roomList: document.getElementById("roomList"),

              currentRoomInfo: document.getElementById("currentRoomInfo"),
              currentRoomName: document.getElementById("currentRoomName"),
              participantCount: document.getElementById("participantCount"),

              subRoomName: document.getElementById("subRoomName"),
              maxParticipants: document.getElementById("maxParticipants"),
              duration: document.getElementById("duration"),
              createSubRoomBtn: document.getElementById("createSubRoomBtn"),
              returnToMainBtn: document.getElementById("returnToMainBtn"),
              subRoomList: document.getElementById("subRoomList"),

              participantList: document.getElementById("participantList"),
              logContainer: document.getElementById("logContainer"),
              clearLogsBtn: document.getElementById("clearLogsBtn"),
              exportLogsBtn: document.getElementById("exportLogsBtn"),
            };

            this.setupEventListeners();
            this.updateConnectionStatus("disconnected");
          }

          setupEventListeners() {
            // Auth buttons
            this.elements.loginBtn.addEventListener("click", () =>
              this.handleLogin()
            );
            this.elements.logoutBtn.addEventListener("click", () =>
              this.handleLogout()
            );
            this.elements.testConnectivityBtn.addEventListener("click", () =>
              this.testConnectivity()
            );

            // Room buttons
            this.elements.createRoomBtn.addEventListener("click", () =>
              this.handleCreateRoom()
            );
            this.elements.joinRoomBtn.addEventListener("click", () =>
              this.handleJoinRoom()
            );
            this.elements.leaveRoomBtn.addEventListener("click", () =>
              this.handleLeaveRoom()
            );
            this.elements.refreshRoomsBtn.addEventListener("click", () =>
              this.handleRefreshRooms()
            );

            // Sub room buttons
            this.elements.createSubRoomBtn.addEventListener("click", () =>
              this.handleCreateSubRoom()
            );
            this.elements.returnToMainBtn.addEventListener("click", () =>
              this.handleReturnToMain()
            );

            // Other buttons
            this.elements.clearLogsBtn.addEventListener("click", () =>
              this.clearLogs()
            );
            this.elements.exportLogsBtn.addEventListener("click", () =>
              this.exportLogs()
            );

            // Enter key handlers
            this.elements.userId.addEventListener("keypress", (e) => {
              if (e.key === "Enter") this.handleLogin();
            });

            this.elements.roomName.addEventListener("keypress", (e) => {
              if (e.key === "Enter") this.handleCreateRoom();
            });

            this.elements.roomCode.addEventListener("keypress", (e) => {
              if (e.key === "Enter") this.handleJoinRoom();
            });

            this.elements.subRoomName.addEventListener("keypress", (e) => {
              if (e.key === "Enter") this.handleCreateSubRoom();
            });
          }

          async testConnectivity() {
            const serverUrl = this.elements.serverUrl.value.trim();
            if (!serverUrl) {
              this.log("Please enter server URL first", "error");
              return;
            }

            try {
              this.elements.testConnectivityBtn.disabled = true;
              this.elements.testConnectivityBtn.textContent = "Testing...";

              // Create temporary client to test connectivity
              const testClient = this.ErmisClassroom.create({
                host: serverUrl,
                debug: true,
              });

              // Test API connectivity (if available)
              const apiClient = testClient.apiClient || testClient._apiClient;
              if (apiClient && apiClient.ping) {
                await apiClient.ping();
                this.log(
                  `Connectivity test successful for ${serverUrl}`,
                  "success"
                );
              } else {
                this.log(
                  `API ping not available, but client created successfully`,
                  "info"
                );
              }
            } catch (error) {
              this.log(`Connectivity test failed: ${error.message}`, "error");
            } finally {
              this.elements.testConnectivityBtn.disabled = false;
              this.elements.testConnectivityBtn.textContent =
                "Test Connectivity";
            }
          }

          async handleLogin() {
            const serverUrl = this.elements.serverUrl.value.trim();
            const userId = this.elements.userId.value.trim();

            if (!serverUrl || !userId) {
              this.log("Please enter both server URL and user ID", "error");
              return;
            }

            if (!userId.includes("@")) {
              this.log("Please enter a valid email address", "error");
              return;
            }

            try {
              this.elements.loginBtn.disabled = true;
              this.elements.loginBtn.textContent = "Connecting...";
              this.updateConnectionStatus("connecting");

              // Create client with production SDK
              this.client = this.ErmisClassroom.create({
                host: serverUrl,
                debug: true,
                autoSaveCredentials: true,
              });

              // Setup event listeners
              this.setupSDKEventListeners();

              // Set UI containers for video rendering
              const mainVideoArea = document.getElementById("mainVideo");
              // const sidebarArea = document.getElementById('participantList').parentElement;
              const sidebarArea = document.getElementById("participantList");
              this.client.setUIContainers(mainVideoArea, sidebarArea);

              // Authenticate
              const user = await this.client.authenticate(userId);

              this.log(`Successfully authenticated as ${user.id}`, "success");
              this.log(`Authentication token received`, "info");
              this.updateConnectionStatus("connected");
              this.showSection("room");

              // Load available rooms
              await this.handleRefreshRooms();
            } catch (error) {
              this.log(`Authentication failed: ${error.message}`, "error");
              this.updateConnectionStatus("disconnected");

              // Log detailed error for debugging
              console.error("Authentication error details:", error);
              if (error.stack) {
                this.log(
                  `Error details: ${error.stack.split("\n")[0]}`,
                  "error"
                );
              }
            } finally {
              this.elements.loginBtn.disabled = false;
              this.elements.loginBtn.textContent = "Login";
            }
          }

          async handleLogout() {
            if (!this.client) return;

            try {
              await this.client.logout();
              this.log("Logged out successfully", "info");
              this.updateConnectionStatus("disconnected");
              this.showSection("auth");
              this.clearParticipants();
              this.clearSubRooms();
              this.client = null;
            } catch (error) {
              this.log(`Logout failed: ${error.message}`, "error");
            }
          }

          async handleCreateRoom() {
            if (!this.client) return;

            const roomName = this.elements.roomName.value.trim();
            const roomType = this.elements.roomType.value;

            if (!roomName) {
              this.log("Please enter a room name", "error");
              return;
            }

            try {
              this.elements.createRoomBtn.disabled = true;
              this.elements.createRoomBtn.textContent = "Creating...";

              const room = await this.client.createRoom({
                name: roomName,
                type: roomType,
              });

              this.log(`Room created: ${room.name} (${room.code})`, "success");
              this.elements.roomName.value = "";

              // Auto-join the created room
              this.log("Auto-joining created room...", "info");
              await this.joinRoomByCode(room.code);
            } catch (error) {
              this.log(`Failed to create room: ${error.message}`, "error");
              console.error("Room creation error:", error);
            } finally {
              this.elements.createRoomBtn.disabled = false;
              this.elements.createRoomBtn.textContent = "Create Room";
            }
          }

          async handleJoinRoom() {
            const roomCode = this.elements.roomCode.value.trim();
            if (!roomCode) {
              this.log("Please enter a room code", "error");
              return;
            }

            await this.joinRoomByCode(roomCode);
          }

          async joinRoomByCode(roomCode) {
            if (!this.client) return;

            try {
              this.elements.joinRoomBtn.disabled = true;
              this.elements.joinRoomBtn.textContent = "Joining...";

              const result = await this.client.joinRoom(roomCode);
              this.currentRoom = result.room;

              this.log(`Joined room: ${result.room.name}`, "success");
              this.log(
                `Local participant: ${result.localParticipant.userId}`,
                "info"
              );
              this.log(
                `Total participants: ${result.participants.length}`,
                "info"
              );

              this.elements.roomCode.value = "";
              this.elements.currentRoomName.textContent = result.room.name;
              this.elements.participantCount.textContent =
                result.participants.length;

              this.showSection("meeting");

              // Display participants
              result.participants.forEach((participant) => {
                this.displayParticipant(participant);
              });
            } catch (error) {
              this.log(`Failed to join room: ${error.message}`, "error");
              console.error("Room join error:", error);
            } finally {
              this.elements.joinRoomBtn.disabled = false;
              this.elements.joinRoomBtn.textContent = "Join Room";
            }
          }

          async handleLeaveRoom() {
            if (!this.client) return;

            try {
              await this.client.leaveRoom();
              this.log("Left room successfully", "info");
              this.showSection("room");
              this.clearParticipants();
              this.clearSubRooms();
              this.currentRoom = null;
            } catch (error) {
              this.log(`Failed to leave room: ${error.message}`, "error");
            }
          }

          async handleRefreshRooms() {
            if (!this.client) return;

            try {
              this.elements.refreshRoomsBtn.disabled = true;
              this.elements.refreshRoomsBtn.textContent = "Loading...";

              const rooms = await this.client.getRooms();
              this.displayRooms(rooms);
              this.log(`Loaded ${rooms.length} rooms`, "info");
            } catch (error) {
              this.log(`Failed to load rooms: ${error.message}`, "error");
              console.error("Room list error:", error);
            } finally {
              this.elements.refreshRoomsBtn.disabled = false;
              this.elements.refreshRoomsBtn.textContent = "Refresh Rooms";
            }
          }

          async handleCreateSubRoom() {
            if (!this.client || !this.currentRoom) return;

            const subRoomName = this.elements.subRoomName.value.trim();
            const maxParticipants =
              parseInt(this.elements.maxParticipants.value) || 5;
            const duration = parseInt(this.elements.duration.value) || 30;

            if (!subRoomName) {
              this.log("Please enter a breakout room name", "error");
              return;
            }

            try {
              this.elements.createSubRoomBtn.disabled = true;
              this.elements.createSubRoomBtn.textContent = "Creating...";

              const subRoom = await this.client.createSubRoom({
                name: subRoomName,
                maxParticipants: maxParticipants,
                duration: duration,
                autoReturn: true,
              });

              this.log(
                `Breakout room created: ${subRoom.name} (max: ${maxParticipants}, duration: ${duration}min)`,
                "success"
              );
              this.elements.subRoomName.value = "";
              this.displaySubRoom(subRoom);
            } catch (error) {
              this.log(
                `Failed to create breakout room: ${error.message}`,
                "error"
              );
              console.error("Sub room creation error:", error);
            } finally {
              this.elements.createSubRoomBtn.disabled = false;
              this.elements.createSubRoomBtn.textContent =
                "Create Breakout Room";
            }
          }

          async handleReturnToMain() {
            if (!this.client) return;

            try {
              const mainRoom = await this.client.returnToMainRoom();
              this.log("Returned to main room", "success");
              this.currentRoom = mainRoom;

              // Update UI
              document
                .querySelectorAll(".subroom-item")
                .forEach((el) => el.classList.remove("active"));
              this.elements.returnToMainBtn.classList.add("hidden");
            } catch (error) {
              this.log(
                `Failed to return to main room: ${error.message}`,
                "error"
              );
            }
          }

          setupSDKEventListeners() {
            if (!this.client) return;

            // Use SDK event constants if available
            const events = this.ErmisClassroom.events || {};

            // Authentication events
            this.client.on(
              events.CLIENT_AUTHENTICATED || "authenticated",
              ({ user }) => {
                this.log(
                  `SDK Event: User authenticated - ${user.id}`,
                  "success"
                );
              }
            );

            this.client.on(events.CLIENT_LOGGED_OUT || "loggedOut", () => {
              this.log("SDK Event: User logged out", "info");
            });

            this.client.on(
              events.CLIENT_CONNECTION_STATUS_CHANGED ||
                "connectionStatusChanged",
              ({ status }) => {
                this.log(
                  `SDK Event: Connection status changed - ${status}`,
                  "info"
                );
                this.updateConnectionStatus(status);
              }
            );

            // Room events
            this.client.on(events.ROOM_CREATED || "roomCreated", ({ room }) => {
              this.log(`SDK Event: Room created - ${room.name}`, "success");
            });

            this.client.on(
              events.ROOM_JOINED || "roomJoined",
              ({ room, participants }) => {
                this.log(
                  `SDK Event: Room joined - ${room.name}  participants:(${participants})`,
                  "success"
                );
              }
            );

            this.client.on(events.ROOM_LEFT || "roomLeft", ({ room }) => {
              this.log(`SDK Event: Room left - ${room.name}`, "info");
            });

            // Participant events
            this.client.on(
              events.PARTICIPANT_ADDED || "participantAdded",
              ({ participant }) => {
                this.log(
                  `SDK Event: Participant joined - ${participant.userId}`,
                  "info"
                );
                this.displayParticipant(participant);
                this.updateParticipantCount();
              }
            );

            this.client.on(
              events.PARTICIPANT_REMOVED || "participantRemoved",
              ({ participant }) => {
                this.log(
                  `SDK Event: Participant left - ${participant.userId}`,
                  "info"
                );
                this.removeParticipant(participant.userId);
                this.updateParticipantCount();
              }
            );

            this.client.on(
              events.PARTICIPANT_PINNED || "participantPinned",
              ({ participant }) => {
                this.log(
                  `SDK Event: Participant pinned - ${participant.userId}`,
                  "info"
                );
                this.updateParticipantDisplay(participant.userId);
              }
            );

            this.client.on(
              events.PARTICIPANT_UNPINNED || "participantUnpinned",
              ({ participant }) => {
                this.log(
                  `SDK Event: Participant unpinned - ${participant.userId}`,
                  "info"
                );
                this.updateParticipantDisplay(participant.userId);
              }
            );

            // Sub room events
            this.client.on(
              events.SUB_ROOM_CREATED || "subRoomCreated",
              ({ subRoom }) => {
                this.log(
                  `SDK Event: Breakout room created - ${subRoom.name}`,
                  "success"
                );
                this.displaySubRoom(subRoom);
              }
            );

            this.client.on(
              events.SUB_ROOM_JOINED || "subRoomJoined",
              ({ subRoom }) => {
                this.log(
                  `SDK Event: Joined breakout room - ${subRoom.name}`,
                  "success"
                );
                this.elements.returnToMainBtn.classList.remove("hidden");
              }
            );

            this.client.on(
              events.SUB_ROOM_SWITCHED || "subRoomSwitched",
              ({ fromSubRoom, toSubRoom }) => {
                this.log(
                  `SDK Event: Switched from ${fromSubRoom.name} to ${toSubRoom.name}`,
                  "info"
                );
              }
            );

            // Error events
            this.client.on(
              events.ERROR || "error",
              ({ error, action, room, participant }) => {
                this.log(`SDK Error in ${action}: ${error.message}`, "error");
                console.error("SDK Error Details:", {
                  error,
                  action,
                  room,
                  participant,
                });
              }
            );
          }

          displayRooms(rooms) {
            const container = this.elements.roomList;
            container.innerHTML = "";

            if (rooms.length === 0) {
              container.innerHTML =
                '<div style="padding: 10px; color: #666;">No rooms available</div>';
              return;
            }

            rooms.forEach((room) => {
              const roomElement = document.createElement("div");
              roomElement.className = "room-item";
              roomElement.innerHTML = `
              <div><strong>${room.room_name}</strong></div>
              <div>Code: <span class="room-code">${room.room_code}</span></div>
              <div style="font-size: 12px; color: #666;">Type: ${room.room_type}</div>
              <div style="font-size: 11px; color: #999;">ID: ${room.id}</div>
            `;

              roomElement.addEventListener("click", () => {
                this.elements.roomCode.value = room.room_code;
                this.handleJoinRoom();
              });

              container.appendChild(roomElement);
            });
          }

          displayParticipant(participant) {
            const container = this.elements.participantList;
            const existingItem = document.getElementById(
              `participant-${participant.userId}`
            );

            if (existingItem) {
              existingItem.remove();
            }

            const participantElement = document.createElement("li");
            participantElement.id = `participant-${participant.userId}`;
            participantElement.className = `participant-item ${
              participant.isLocal ? "local" : ""
            } ${participant.isPinned ? "pinned" : ""}`;

            const displayName = participant.isLocal
              ? `${participant.userId} (You)`
              : participant.userId;
            const roleIcon =
              participant.role === "owner"
                ? " üëë"
                : participant.role === "moderator"
                ? " üîß"
                : "";

            participantElement.innerHTML = `
            <div>
              <strong>${displayName}${roleIcon}</strong>
              <div style="font-size: 11px; color: #666;">${
                participant.role || "participant"
              }</div>
            </div>
            <div class="participant-controls">
              <button class="control-btn ${
                participant.isAudioEnabled ? "" : "muted"
              }" 
                      onclick="demo.toggleParticipantAudio('${
                        participant.userId
                      }')">
                ${participant.isAudioEnabled ? "üé§" : "üîá"}
              </button>
              <button class="control-btn" onclick="demo.toggleParticipantPin('${
                participant.userId
              }')">
                ${participant.isPinned ? "üìå" : "üìç"}
              </button>
              ${
                participant.isLocal
                  ? `
                <button class="control-btn ${
                  participant.isVideoEnabled ? "" : "muted"
                }" 
                        onclick="demo.toggleParticipantVideo('${
                          participant.userId
                        }')">
                  ${participant.isVideoEnabled ? "üìπ" : "üìµ"}
                </button>
              `
                  : ""
              }
            </div>
          `;

            container.appendChild(participantElement);
            this.participants.set(participant.userId, participant);
          }

          updateParticipantDisplay(userId) {
            const participant = this.participants.get(userId);
            if (participant) {
              this.displayParticipant(participant);
            }
          }

          removeParticipant(userId) {
            const participantElement = document.getElementById(
              `participant-${userId}`
            );
            if (participantElement) {
              participantElement.remove();
            }
            this.participants.delete(userId);
          }

          clearParticipants() {
            this.elements.participantList.innerHTML = "";
            this.participants.clear();
          }

          updateParticipantCount() {
            this.elements.participantCount.textContent = this.participants.size;
          }

          displaySubRoom(subRoom) {
            const container = this.elements.subRoomList;
            const subRoomElement = document.createElement("div");
            subRoomElement.className = "subroom-item";
            subRoomElement.setAttribute("data-subroom-id", subRoom.id);

            const stats = subRoom.getStats ? subRoom.getStats() : subRoom;
            subRoomElement.innerHTML = `
            <div><strong>${subRoom.name}</strong></div>
            <div class="room-code">${subRoom.code}</div>
            <div style="font-size: 11px; color: #666;">
              Max: ${stats.maxParticipants || "N/A"} | 
              Duration: ${stats.duration || "Unlimited"}min
            </div>
          `;

            subRoomElement.addEventListener("click", async () => {
              try {
                await this.client.joinSubRoom(subRoom.code);
                this.log(`Joined breakout room: ${subRoom.name}`, "success");

                // Update UI
                document
                  .querySelectorAll(".subroom-item")
                  .forEach((el) => el.classList.remove("active"));
                subRoomElement.classList.add("active");
                this.elements.returnToMainBtn.classList.remove("hidden");
              } catch (error) {
                this.log(
                  `Failed to join breakout room: ${error.message}`,
                  "error"
                );
              }
            });

            container.appendChild(subRoomElement);
            this.subRooms.set(subRoom.id, subRoom);
          }

          clearSubRooms() {
            this.elements.subRoomList.innerHTML = "";
            this.elements.returnToMainBtn.classList.add("hidden");
            this.subRooms.clear();
          }

          // Participant control methods (these will call actual SDK methods)
          async toggleParticipantAudio(userId) {
            this.log(`Toggle audio for ${userId}`, "info");

            const participant = this.participants.get(userId);
            if (!participant) return;

            try {
              if (participant.isLocal) {
                // Use SDK's local participant methods
                await participant.toggleMicrophone();
              } else {
                // Use SDK's remote participant methods
                await participant.toggleRemoteAudio();
              }
            } catch (error) {
              this.log(
                `Failed to toggle audio for ${userId}: ${error.message}`,
                "error"
              );
            }
          }

          async toggleParticipantVideo(userId) {
            this.log(`Toggle video for ${userId}`, "info");

            const participant = this.participants.get(userId);
            if (!participant || !participant.isLocal) return;

            try {
              await participant.toggleCamera();
            } catch (error) {
              this.log(
                `Failed to toggle video for ${userId}: ${error.message}`,
                "error"
              );
            }
          }

          async toggleParticipantPin(userId) {
            this.log(`Toggle pin for ${userId}`, "info");

            try {
              if (this.currentRoom) {
                const currentPinned = this.currentRoom.pinnedParticipant;

                if (currentPinned && currentPinned.userId === userId) {
                  await this.currentRoom.unpinParticipant();
                } else {
                  await this.currentRoom.pinParticipant(userId);
                }
              }
            } catch (error) {
              this.log(
                `Failed to toggle pin for ${userId}: ${error.message}`,
                "error"
              );
            }
          }

          updateConnectionStatus(status) {
            const statusElement = this.elements.connectionStatus;
            statusElement.className = `status ${status}`;

            const statusText =
              {
                disconnected: "Disconnected",
                connecting: "Connecting...",
                connected: "Connected",
                failed: "Connection Failed",
              }[status] || status;

            statusElement.textContent = statusText;
          }

          showSection(section) {
            // Hide all sections
            this.elements.authSection.classList.add("hidden");
            this.elements.roomSection.classList.add("hidden");
            this.elements.breakoutSection.classList.add("hidden");
            this.elements.meetingArea.classList.add("hidden");

            this.elements.loginBtn.classList.toggle(
              "hidden",
              section !== "auth"
            );
            this.elements.logoutBtn.classList.toggle(
              "hidden",
              section === "auth"
            );
            this.elements.currentRoomInfo.classList.add("hidden");

            // Show appropriate sections
            switch (section) {
              case "auth":
                this.elements.authSection.classList.remove("hidden");
                break;
              case "room":
                this.elements.roomSection.classList.remove("hidden");
                break;
              case "meeting":
                this.elements.roomSection.classList.remove("hidden");
                this.elements.breakoutSection.classList.remove("hidden");
                this.elements.meetingArea.classList.remove("hidden");
                this.elements.currentRoomInfo.classList.remove("hidden");
                break;
            }
          }

          log(message, type = "info") {
            const container = this.elements.logContainer;
            const logEntry = document.createElement("div");
            logEntry.className = `log-entry ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            const typeIcon =
              {
                info: "‚ÑπÔ∏è",
                success: "‚úÖ",
                error: "‚ùå",
                warning: "‚ö†Ô∏è",
              }[type] || "‚ÑπÔ∏è";

            logEntry.innerHTML = `[${timestamp}] ${typeIcon} ${message}`;

            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;

            // Keep only last 100 log entries
            while (container.children.length > 100) {
              container.removeChild(container.firstChild);
            }

            // Store logs for export
            if (!this.logs) this.logs = [];
            this.logs.push({
              timestamp: new Date().toISOString(),
              type,
              message,
            });
          }

          clearLogs() {
            this.elements.logContainer.innerHTML = "";
            this.logs = [];
          }

          exportLogs() {
            if (!this.logs || this.logs.length === 0) {
              this.log("No logs to export", "warning");
              return;
            }

            const logText = this.logs
              .map(
                (log) =>
                  `[${new Date(
                    log.timestamp
                  ).toLocaleString()}] ${log.type.toUpperCase()}: ${
                    log.message
                  }`
              )
              .join("\n");

            const blob = new Blob([logText], { type: "text/plain" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `ermis-sdk-logs-${new Date()
              .toISOString()
              .slice(0, 19)
              .replace(/:/g, "-")}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            this.log(`Exported ${this.logs.length} log entries`, "success");
          }
        }

        // Initialize demo with real SDK
        window.demo = new ProductionDemo(ErmisClassroom);

        // Log initial SDK info
        demo.log(
          "Production demo initialized with real ErmisClassroom SDK",
          "success"
        );
        demo.log(
          `Available room types: ${Object.values(
            ErmisClassroom.RoomTypes || {}
          ).join(", ")}`,
          "info"
        );
        demo.log(
          `Available participant roles: ${Object.values(
            ErmisClassroom.ParticipantRoles || {}
          ).join(", ")}`,
          "info"
        );

        // Pre-fill demo data for development
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          demo.elements.userId.value = "demo-user@example.com";
          demo.log("Demo credentials pre-filled for local development", "info");
        }

        // Test media device access
        if (ErmisClassroom.MediaDevices) {
          ErmisClassroom.MediaDevices.checkPermissions()
            .then((permissions) => {
              demo.log(
                `Media permissions - Camera: ${
                  permissions.camera?.state || "unknown"
                }, Microphone: ${permissions.microphone?.state || "unknown"}`,
                "info"
              );
            })
            .catch((error) => {
              demo.log(
                `Could not check media permissions: ${error.message}`,
                "warning"
              );
            });
        }
      };

      // Fallback if SDK fails to load
      setTimeout(() => {
        if (!window.demo) {
          document.getElementById("versionInfo").innerHTML =
            '<span style="color: red;">‚ùå Failed to load SDK. Please check:</span><br>' +
            "‚Ä¢ SDK build files exist in ./dist/ directory<br>" +
            "‚Ä¢ Server is running and accessible<br>" +
            "‚Ä¢ Browser supports ES6 modules";

          console.error(
            "SDK loading timeout. Check build files and network connectivity."
          );
        }
      }, 5000);
    </script>
  </body>
</html>
